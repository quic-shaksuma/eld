# REQUIRES: x86
# RUN: llvm-mc -filetype=obj -triple=x86_64 %s -o %t.o

## -z noseparate-code. All PT_LOAD can have overlapping p_offset
## ranges at runtime.
# RUN: %link -pie --no-align-segments --rosegment %t.o -o %t
# RUN: llvm-readelf -l %t | FileCheck --check-prefix=NONE %s
# NONE:      LOAD 0x000000 0x0000000000000000 0x0000000000000000 0x000200 0x000200 R E 0x1000
# NONE-NEXT: LOAD 0x000200 0x0000000000000200 0x0000000000000200 0x000044 0x000044 R   0x1000
# NONE-NEXT: LOAD 0x000244 0x0000000000000244 0x0000000000000244 0x000001 0x000001 R E 0x1000
# NONE-NEXT: LOAD 0x000245 0x0000000000000245 0x0000000000000245 0x000001 0x000001 R   0x1000
# NONE-NEXT: LOAD 0x000248 0x0000000000000248 0x0000000000000248 0x0000f1 0x0000f1 RW  0x1000

## -z separate-code makes text segment (RX) separate.
## The two RW can have overlapping p_offset ranges at runtime.
# RUN: %link -pie --no-align-segments --rosegment %t.o -z separate-code -o %t
# RUN: llvm-readelf -l %t | FileCheck --check-prefix=CODE %s
# CODE:      LOAD 0x000000 0x0000000000000000 0x0000000000000000 0x000200 0x000200 R E 0x1000
# CODE-NEXT: LOAD 0x001000 0x0000000000001000 0x0000000000001000 0x000044 0x000044 R   0x1000
# CODE-NEXT: LOAD 0x002000 0x0000000000002000 0x0000000000002000 0x000001 0x000001 R E 0x1000
# CODE-NEXT: LOAD 0x003000 0x0000000000003000 0x0000000000003000 0x000001 0x000001 R   0x1000
# CODE-NEXT: LOAD 0x003008 0x0000000000003008 0x0000000000003008 0x0000f1 0x0000f1 RW  0x1000

## TODO:
## -z separate-loadable-segments makes all segments separate.
# %link -pie --no-align-segments --rosegment %t.o -z separate-loadable-segments -o %t
# llvm-readelf -l %t | FileCheck --check-prefix=ALL %s
# ALL:      LOAD 0x000000 0x0000000000000000 0x0000000000000000 0x000200 0x000200 R E 0x1000
# ALL-NEXT: LOAD 0x001000 0x0000000000001000 0x0000000000001000 0x000044 0x000044 R   0x1000
# ALL-NEXT: LOAD 0x002000 0x0000000000002000 0x0000000000002000 0x000001 0x000001 R E 0x1000
# ALL-NEXT: LOAD 0x003000 0x0000000000003000 0x0000000000003000 0x000001 0x000001 R   0x1000
# ALL-NEXT: LOAD 0x004000 0x0000000000004000 0x0000000000004000 0x0000f1 0x0000f1 RW  0x1000

nop

.section .rodata,"a"
.byte 0

.data
.byte 0
