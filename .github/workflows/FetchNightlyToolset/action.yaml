name: FetchNightlyToolset
description: Fetch nightly toolset generated by nightly-test.yml workflow
runs:
  using: "composite"
  steps:
    - name: Get latest run id of nightly-test.yml workflow
      id: latest
      uses: actions/github-script@v8
      with:
        github-token: ${{ github.token }}
        script: |
          const workflowId = 'nightly-test.yml';
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          const status = 'success';
          const resp = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowId,
              status,
              per_page: 1, // we only need the latest
              page: 1
            });
          if (!resp.data.workflow_runs || resp.data.workflow_runs.length === 0) {
              core.setFailed(`No runs found for workflow "${workflowId}" on
                branch "${branch}" with status "${status}".`);
              return;
            }
            const run = resp.data.workflow_runs[0];
            core.info(`Latest run id: ${run.id}, run_number: ${run.run_number},
              conclusion: ${run.conclusion}`);
            core.setOutput('run_id', String(run.id));

    - name: Download toolset
      uses: actions/download-artifact@v4
      with:
        name: install-nightly-toolchain.tar.xz
        github-token: ${{ github.token }}
        run-id: ${{ steps.latest.outputs.run_id }}

    - name: Extract toolset
      shell: bash
      run: |
        mkdir -p inst
        tar -xvf install-nightly-toolchain.tar.xz -C inst --strip-components=1
        ls inst
        echo "PATH=$(pwd)/inst/bin:$PATH" >> $GITHUB_ENV
