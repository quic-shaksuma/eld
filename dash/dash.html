<!DOCTYPE html>
<html>
<head>
<title>Build Status</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="Footer" content="DeepDash by Deepmap">
<link rel="stylesheet" type="text/css" href="builds-summary-style.css">
<link href="https://code.jquery.com/ui/1.13.3/themes/smoothness/jquery-ui.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/jquery-ui-daterangepicker@1.0.3-yrd/jquery.comiseo.daterangepicker.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-ui-daterangepicker@1.0.3-yrd/jquery.comiseo.daterangepicker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  $(function() { $("#datePicker").daterangepicker();});
</script>
<script type="text/javascript" src="picolibc_status_data.py"></script>
<script type="text/javascript" src="musl_status_data.py"></script>
<script type="text/javascript" src="sanitizer_status_data.py"></script>
<script type="text/javascript" src="nightly_status_data.py"></script>
<script type="text/javascript" src="reverse_iterator_status_data.py"></script>
<script type="text/javascript" src="documentation_status_data.py"></script>
<script type="text/javascript" src="release_status_data.py"></script>
</head>

<body style="overflow: hidden;">
  <h1 id='page-title'>Build Status</h1>
  <br>
  <div id="filters-div">
    <input id="datePicker" name="datePicker">
    &nbsp;&nbsp;
    <button onclick="window.location.reload()" style="height:38px; border-style:hidden; border-radius: 18%;">Reset</button>
  </div>
  <br>
  <div id="content-div">
    <div class="all-builds flex-parent" id="all-builds-div">
      <div class="Build1 flex-child" id="picolibcPie-div" style="max-width:400px;border:2px solid skyblue;border-style:inset hidden hidden inset;border-radius: 18px;">
        <canvas id="picolibcPie"></canvas><br>
        &nbsp;&nbsp;&nbsp;&nbsp;Picolibc Status <sub><span id="picolibc_green" class="status status-pass"></span><span id="picolibc_red" class="status status-fail"></span></sub><label for="select_picolibc" style="position: relative; left: 180px;">Filter: </label><input type="checkbox" id="select_picolibc" name="select_picolibc" checked style="position: relative; left: 180px;">
      </div>
      <div class="Build2 flex-child" id="muslPie-div" style="max-width: 400px;border:2px solid skyblue;border-style:inset hidden hidden inset;border-radius: 18px;">
        <canvas id="muslPie"></canvas>
        <br>
        &nbsp;&nbsp;&nbsp;&nbsp;MUSL Status <sub><span id="musl_green" class="status status-pass"></span><span id="musl_red" class="status status-fail"></span></sub><label for="select_musl" style="position: relative; left: 180px;">Filter: </label><input type="checkbox" id="select_musl" name="select_musl" checked style="position: relative; left: 180px;">
      </div>
      <div class="Build3 flex-child" id="sanitizerPie-div" style="max-width: 400px;border:2px solid skyblue;border-style:inset hidden hidden inset;border-radius: 18px;">
        <canvas id="sanitizerPie"></canvas>
        <br>
        &nbsp;&nbsp;&nbsp;&nbsp;Sanitizer Status <sub><span id="sanitizer_green" class="status status-pass"></span><span id="sanitizer_red" class="status status-fail"></span></sub><label for="select_sanitizer" style="position: relative; left: 180px;">Filter: </label><input type="checkbox" id="select_sanitizer" name="select_sanitizer" checked style="position: relative; left: 180px;">
      </div>
      <div class="Build4 flex-child" id="nightlyPie-div" style="max-width: 400px;border:2px solid skyblue;border-style:inset hidden hidden inset;border-radius: 18px;">
        <canvas id="nightlyPie"></canvas>
        <br>
        &nbsp;&nbsp;&nbsp;&nbsp;Nightly Status <sub><span id="nightly_green" class="status status-pass"></span><span id="nightly_red" class="status status-fail"></span></sub><label for="select_nightly" style="position: relative; left: 180px;">Filter: </label><input type="checkbox" id="select_nightly" name="select_nightly" checked style="position: relative; left: 180px;">
      </div>
      <div class="Build5 flex-child" id="reverse_iteratorPie-div" style="max-width: 400px;border:2px solid skyblue;border-style:inset hidden hidden inset;border-radius: 18px;">
        <canvas id="reverseIteratorPie"></canvas>
        <br>
        &nbsp;&nbsp;&nbsp;&nbsp;Reverse Iterator Status <sub><span id="reverse_iterator_green" class="status status-pass"></span><span id="reverse_iterator_red" class="status status-fail"></span></sub><label for="select_reverse_iterator" style="position: relative; left: 130px;">Filter: </label><input type="checkbox" id="select_reverse_iterator" name="select_reverse_iterator" checked style="position: relative; left: 130px;">
      </div>
      <div class="Build6 flex-child" id="documentationPie-div" style="max-width: 400px;border:2px solid skyblue;border-style:inset hidden hidden inset;border-radius: 18px;">
        <canvas id="documentationPie"></canvas>
        <br>
        &nbsp;&nbsp;&nbsp;&nbsp;Documentation Status <sub><span id="documentation_green" class="status status-pass"></span><span id="documentation_red" class="status status-fail"></span></sub><label for="select_documentation" style="position: relative; left: 145px;">Filter: </label><input type="checkbox" id="select_documentation" name="select_documentation" checked style="position: relative; left: 145px;">
      </div>
      <div class="Build7 flex-child" id="releasePie-div" style="max-width: 400px;border:2px solid skyblue;border-style:inset hidden hidden inset;border-radius: 18px;">
        <canvas id="releasePie"></canvas>
        <br>
        &nbsp;&nbsp;&nbsp;&nbsp;Release Status <sub><span id="release_green" class="status status-pass"></span><span id="release_red" class="status status-fail"></span></sub><label for="select_release" style="position: relative; left: 180px;">Filter: </label><input type="checkbox" id="select_release" name="select_release" checked style="position: relative; left: 180px;">
      </div>
    </div>
  </div>

  <script>
    function hasData(build_name) {
      return ((typeof globalThis[build_name.toLowerCase()+'_build_states'] == 'undefined') || (!globalThis[build_name.toLowerCase()+'_build_states'].length));
    }

    // Hide charts that have no data.
    var childDivs = $('#all-builds-div').children('div');
    let data_found = false;
    childDivs.each(function() {
      let build_name = $(this).attr('id').split('Pie-div')[0];
      if (hasData(build_name)) {
        console.log(build_name + " build data not found!");
        $('#'+ build_name + 'Pie-div').hide();
      } else {
        data_found = true;
      }
    });
    if (!data_found) {
      $('#all-builds-div').html("<h2><center>No Build Data Available</center></h2>");
    }
  </script>

  <script>
  $('#page-title').click(function() { window.location.reload(); });
  const pico = document.getElementById("picolibcPie");
  const lastPicoBuild = picolibc_build_states[picolibc_build_states.length - 1];
  if (lastPicoBuild) {
      if(lastPicoBuild.state == 'pass') {
        $("#picolibc_green").show();
        $("#picolibc_red").hide();
      }
      else if(lastPicoBuild.state == 'fail') {
        $("#picolibc_green").hide();
        $("#picolibc_red").show();
      }
  } else {
    $("#picolibc_green").hide();
    $("#picolibc_red").hide();
  }
  let pico_passes = 0;
  let pico_fails = 0;
  picolibc_build_states.forEach(function(value, key) {
    if(value.state == 'pass')
      pico_passes += 1;
    else if (value.state == 'fail')
      pico_fails += 1;
  });
  const picolibc_pie = new Chart(pico, {
    type: 'pie',
    data: {
      labels: ['Pass', 'Fail'],
      datasets: [{
        label: '#Builds',
        data: [pico_passes, pico_fails],
        borderWidth: 2,
        backgroundColor: [
        'lightgreen',
        'red'
      ],
    hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: 'Picolibc Builds'
      },
        onClick: (e) => {
            window.open("picolibcBuilds.html", "_blank");
        }
    }
  });
  </script>

  <script>
  const musl = document.getElementById("muslPie");
  const lastMUSLBuild = musl_build_states[musl_build_states.length - 1];
  if (lastMUSLBuild) {
      if(lastMUSLBuild.state == 'pass') {
        $("#musl_green").show();
        $("#musl_red").hide();
      }
      else if(lastMUSLBuild.state == 'fail') {
        $("#musl_green").hide();
        $("#musl_red").show();
      }
  } else {
    $("#musl_green").hide();
    $("#musl_red").hide();
  }
  let musl_passes = 0;
  let musl_fails = 0;
  musl_build_states.forEach(function(value, key) {
    if(value.state == 'pass')
      musl_passes += 1;
    else if (value.state == 'fail')
      musl_fails += 1;
  });
  const musl_pie = new Chart(musl, {
    type: 'pie',
    data: {
      labels: ['Pass', 'Fail'],
      datasets: [{
        label: '#Builds',
        data: [musl_passes, musl_fails],
        borderWidth: 2,
        backgroundColor: [
        'lightgreen',
        'red'
      ],
      hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: 'MUSL Builds'
      },
        onClick: (e) => {
            window.open("muslBuilds.html", "_blank");
        }
    }
  });
  </script>

  <script>
  const sanitizer = document.getElementById("sanitizerPie");
  const lastSanitizerBuild = sanitizer_build_states[sanitizer_build_states.length - 1];
  if (lastSanitizerBuild) {
      if(lastSanitizerBuild.state == 'pass') {
        $("#sanitizer_green").show();
        $("#sanitizer_red").hide();
      }
      else if(lastSanitizerBuild.state == 'fail') {
        $("#sanitizer_green").hide();
        $("#sanitizer_red").show();
      }
  } else {
    $("#sanitizer_green").hide();
    $("#sanitizer_red").hide();
  }
  let sanitizer_passes = 0;
  let sanitizer_fails = 0;
  sanitizer_build_states.forEach(function(value, key) {
    if(value.state == 'pass')
      sanitizer_passes += 1;
    else if (value.state == 'fail')
      sanitizer_fails += 1;
  });
  const sanitizer_pie = new Chart(sanitizer, {
    type: 'pie',
    data: {
      labels: ['Pass', 'Fail'],
      datasets: [{
        label: '#Builds',
        data: [sanitizer_passes, sanitizer_fails],
        borderWidth: 2,
        backgroundColor: [
        'lightgreen',
        'red'
      ],
      hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: 'Sanitizer Builds'
      },
        onClick: (e) => {
            window.open("sanitizerBuilds.html", "_blank");
        }
    }
  });
  </script>

  <script>
  const nightly = document.getElementById("nightlyPie");
  const lastNightlyBuild = nightly_build_states[nightly_build_states.length - 1];
  if (lastNightlyBuild) {
      if(lastNightlyBuild.state == 'pass') {
        $("#nightly_green").show();
        $("#nightly_red").hide();
      }
      else if(lastNightlyBuild.state == 'fail') {
        $("#nightly_green").hide();
        $("#nightly_red").show();
      }
  } else {
    $("#nightly_green").hide();
    $("#nightly_red").hide();
  }
  let nightly_passes = 0;
  let nightly_fails = 0;
  nightly_build_states.forEach(function(value, key) {
    if(value.state == 'pass')
      nightly_passes += 1;
    else if (value.state == 'fail')
      nightly_fails += 1;
  });
  const nightly_pie = new Chart(nightly, {
    type: 'pie',
    data: {
      labels: ['Pass', 'Fail'],
      datasets: [{
        label: '#Builds',
        data: [nightly_passes, nightly_fails],
        borderWidth: 2,
        backgroundColor: [
        'lightgreen',
        'red'
      ],
      hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: 'Nightly Builds'
      },
        onClick: (e) => {
            window.open("nightlyBuilds.html", "_blank");
        }
    }
  });
  </script>

  <script>
  const reverseIterator = document.getElementById("reverseIteratorPie");
  const lastReverseIteratorBuild = reverse_iterator_build_states[reverse_iterator_build_states.length - 1];
  if (lastReverseIteratorBuild) {
      if(lastReverseIteratorBuild.state == 'pass') {
        $("#reverse_iterator_green").show();
        $("#reverse_iterator_red").hide();
      }
      else if(lastReverseIteratorBuild.state == 'fail') {
        $("#reverse_iterator_green").hide();
        $("#reverse_iterator_red").show();
      }
  } else {
    $("#reverse_iterator_green").hide();
    $("#reverse_iterator_red").hide();
  }
  let reverse_iterator_passes = 0;
  let reverse_iterator_fails = 0;
  reverse_iterator_build_states.forEach(function(value, key) {
    if(value.state == 'pass')
      reverse_iterator_passes += 1;
    else if (value.state == 'fail')
      reverse_iterator_fails += 1;
  });
  const reverse_iterator_pie = new Chart(reverseIterator, {
    type: 'pie',
    data: {
      labels: ['Pass', 'Fail'],
      datasets: [{
        label: '#Builds',
        data: [reverse_iterator_passes, reverse_iterator_fails],
        borderWidth: 2,
        backgroundColor: [
        'lightgreen',
        'red'
      ],
      hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: 'Reverse Iterator Builds'
      },
        onClick: (e) => {
            window.open("reverse_iteratorBuilds.html", "_blank");
        }
    }
  });
  </script>

  <script>
  const documentation = document.getElementById("documentationPie");
  const lastDocumentationBuild = documentation_build_states[documentation_build_states.length - 1];
  if (lastDocumentationBuild) {
      if(lastDocumentationBuild.state == 'pass') {
        $("#documentation_green").show();
        $("#documentation_red").hide();
      }
      else if(lastDocumentationBuild.state == 'fail') {
        $("#documentation_green").hide();
        $("#documentation_red").show();
      }
  } else {
    $("#documentation_green").hide();
    $("#documentation_red").hide();
  }
  let documentation_passes = 0;
  let documentation_fails = 0;
  documentation_build_states.forEach(function(value, key) {
    if(value.state == 'pass')
      documentation_passes += 1;
    else if (value.state == 'fail')
      documentation_fails += 1;
  });
  const documentation_pie = new Chart(documentation, {
    type: 'pie',
    data: {
      labels: ['Pass', 'Fail'],
      datasets: [{
        label: '#Builds',
        data: [documentation_passes, documentation_fails],
        borderWidth: 2,
        backgroundColor: [
        'lightgreen',
        'red'
      ],
      hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: 'Documentation Builds'
      },
        onClick: (e) => {
            window.open("documentationBuilds.html", "_blank");
        }
    }
  });
  </script>

  <script>
  const release = document.getElementById("releasePie");
  const lastReleaseBuild = release_build_states[release_build_states.length - 1];
  if (lastReleaseBuild) {
      if(lastReleaseBuild.state == 'pass') {
        $("#release_green").show();
        $("#release_red").hide();
      }
      else if(lastReleaseBuild.state == 'fail') {
        $("#release_green").hide();
        $("#release_red").show();
      }
  } else {
    $("#release_green").hide();
    $("#release_red").hide();
  }
  let release_passes = 0;
  let release_fails = 0;
  release_build_states.forEach(function(value, key) {
    if(value.state == 'pass')
      release_passes += 1;
    else if (value.state == 'fail')
      release_fails += 1;
  });
  const release_pie = new Chart(release, {
    type: 'pie',
    data: {
      labels: ['Pass', 'Fail'],
      datasets: [{
        label: '#Builds',
        data: [release_passes, release_fails],
        borderWidth: 2,
        backgroundColor: [
        'lightgreen',
        'red'
      ],
      hoverOffset: 4
      }]
    },
    options: {
      responsive: true,
      title: {
        display: true,
        text: 'Release Builds'
      },
        onClick: (e) => {
            window.open("releaseBuilds.html", "_blank");
        }
    }
  });
  </script>

  <script type="text/javascript">
    // Date filter
    function getUpdatedData(currentData, start_date, end_date) {
      let updated_passes = 0;
      let updated_fails = 0;
      currentData.forEach(function(value, key) {
        const range_start = new Date(start_date);
        const range_end = new Date(end_date);
        const build_date = new Date(value.date)
        if (build_date >= range_start && build_date <= range_end) {
          if(value.state == 'pass')
            updated_passes += 1;
          else if (value.state == 'fail')
            updated_fails += 1;
        }
      });
      return [updated_passes, updated_fails];
    }

  function filterPies(start_date, end_date) {
    // Configuration array mapping selectors to their respective data and chart objects
    const chartConfigs = [
      { selector: '#select_picolibc',         states: picolibc_build_states,         chart: picolibc_pie,             label: 'Picolibc' },
      { selector: '#select_musl',             states: musl_build_states,             chart: musl_pie,             label: 'MUSL' },
      { selector: '#select_sanitizer',        states: sanitizer_build_states,        chart: sanitizer_pie,        label: 'Sanitizer' },
      { selector: '#select_nightly',          states: nightly_build_states,          chart: nightly_pie,          label: 'Nightly' },
      { selector: '#select_reverse_iterator', states: reverse_iterator_build_states, chart: reverse_iterator_pie, label: 'Reverse Iterator' },
      { selector: '#select_documentation',    states: documentation_build_states,    chart: documentation_pie,    label: 'Documentation' },
      { selector: '#select_release',          states: release_build_states,          chart: release_pie,          label: 'Release' }
    ];

    // Iterate over configs and update charts if selected
    chartConfigs.forEach(config => {
      if ($(config.selector).prop('checked')) {
        let newData = getUpdatedData(config.states, start_date, end_date);
        console.log(`Updating ${config.label} Pie Chart for Selected Date Range.`);
        config.chart.data.datasets[0].data = [newData[0], newData[1]];
        config.chart.update();
      }
    });
  }

  $("#datePicker").on('change', function(event) {
    var range = $("#datePicker").val();
    if (range.length) {
      const date_range = JSON.parse(range);
      filterPies(date_range.start, date_range.end);
    }
  });
  </script>

  <footer class="footer">
    DeepDash - Builds <sub>~DeepMap</sub>
  </footer>

</body>
</html>